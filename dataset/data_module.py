# /workspace/CheXpert/R2GenGPT/dataset/data_module.py

from pytorch_lightning import LightningDataModule
from torch.utils.data import DataLoader
from dataset.data_helper import create_datasets



class DataModule(LightningDataModule):
    def __init__(self, args):
        super().__init__()
        self.args = args
    
    def setup(self, stage: str):
        train_dataset, dev_dataset, test_dataset = create_datasets(self.args)
        self.dataset = {
            "train": train_dataset,
            "validation": dev_dataset,
            "test": test_dataset
        }
    
    def train_dataloader(self):
        return DataLoader(
            self.dataset["train"],
            batch_size=self.args.batch_size,
            drop_last=True,
            pin_memory=True,
            num_workers=self.args.num_workers,
            prefetch_factor=self.args.prefetch_factor,
            shuffle=True
        )
    
    def val_dataloader(self):
        return DataLoader(
            self.dataset["validation"],
            batch_size=self.args.val_batch_size,
            drop_last=False,
            pin_memory=True,
            num_workers=self.args.num_workers,
            prefetch_factor=self.args.prefetch_factor
        )
    
    def test_dataloader(self):
        return DataLoader(
            self.dataset["test"],
            batch_size=self.args.test_batch_size,
            drop_last=False,
            pin_memory=False,
            num_workers=self.args.num_workers,
            prefetch_factor=self.args.prefetch_factor
        )